// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enum định nghĩa theo thiết kế của bạn ---
enum UserRole {
  BUYER
  SELLER
  ADMIN
}

enum OrderStatus {
  PENDING          // Chờ người bán xác nhận
  CONFIRMED        // Người bán đã xác nhận
  SHIPPING         // Đang giao hàng
  COMPLETED        // Hoàn thành (buyer xác nhận nhận)
  CANCELLED        // Đã hủy
  ISSUE_REPORTED   // Có sự cố (buyer báo chưa nhận)
  FAILED           // Giao thất bại (sau khi seller xác nhận)
}

enum PaymentStatus {
  UNPAID    // Chưa thanh toán (COD chờ nhận / online chờ)
  PAID      // Đã thanh toán xong
  REFUNDING // Đang hoàn tiền (online đã trả trước, hàng thất lạc)
  REFUNDED  // Đã hoàn tiền xong
  FAILED    // Thanh toán thất bại
}

enum PaymentMethod {
  COD      // Thanh toán khi nhận hàng
  QR_CODE  // QR ngân hàng
  MOMO     // Ví MoMo
  ZALOPAY  // ZaloPay
}

enum TargetType {
  PRODUCT
  AVATAR
  PAYMENT_PROOF
}

// --- Enum mới cho OTP (Theo repo mẫu) ---
enum AccountIdentifier {
  EMAIL
  PHONE
}

// --- Các Model chính ---

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  password_hash  String
  role           UserRole  @default(BUYER)
  full_name      String
  phone_number   String?
  
  // --- THÊM TRƯỜNG XÁC THỰC ---
  verified_email Boolean   @default(false)
  
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  profile        Profile?
  products       Product[]
  buy_orders     Order[]         @relation("BuyerOrders")
  sell_orders    Order[]         @relation("SellerOrders")
  payments       Payment[]
  sent_messages  ChatMessage[]
  conv_user1     Conversation[]  @relation("User1")
  conv_user2     Conversation[]  @relation("User2")
  reviews        Review[]
  
  // Liên kết với bảng Verification
  verifications  Verification[]
}

model Profile {
  id             String   @id @default(cuid())
  user_id        String   @unique
  user           User     @relation(fields: [user_id], references: [id])
  store_name     String?
  address        String?
  description    String?  @db.Text
  is_verified    Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
}

model Category {
  id             Int       @id @default(autoincrement())
  name           String    @unique
  parent_id      Int?
  parent         Category? @relation("SubCategories", fields: [parent_id], references: [id])
  sub_categories Category[] @relation("SubCategories")
  products       Product[]
  created_at     DateTime  @default(now())
}

model Product {
  id              String      @id @default(cuid())
  seller_id       String
  seller          User        @relation(fields: [seller_id], references: [id])
  category_id     Int
  category        Category    @relation(fields: [category_id], references: [id])
  name            String
  description     String?     @db.Text
  reference_price Decimal     @db.Decimal(10, 2)
  stock_quantity  Decimal     @db.Decimal(10, 2)
  unit            String
  location        String?
  certification   String?
  is_active       Boolean     @default(true)
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  order_items     OrderItem[]
}

model Order {
  id                String        @id @default(cuid())
  buyer_id          String
  buyer             User          @relation("BuyerOrders", fields: [buyer_id], references: [id])
  seller_id         String
  seller            User          @relation("SellerOrders", fields: [seller_id], references: [id])
  status            OrderStatus   @default(PENDING)
  payment_method    PaymentMethod @default(COD)
  final_total_price Decimal       @db.Decimal(10, 2)
  shipping_address  String
  tracking_code     String?
  note              String?       // Ghi chú khi báo sự cố
  shipped_at        DateTime?     // Thời điểm chuyển sang SHIPPING — dùng để tính timer báo sự cố
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  order_items       OrderItem[]
  payments          Payment[]
  reviews           Review[]
}

model OrderItem {
  id               String  @id @default(cuid())
  order_id         String
  order            Order   @relation(fields: [order_id], references: [id])
  product_id       String
  product          Product @relation(fields: [product_id], references: [id])
  quantity         Decimal @db.Decimal(10, 2)
  negotiated_price Decimal @db.Decimal(10, 2)
}

model Payment {
  id                String        @id @default(cuid())
  order_id          String
  order             Order         @relation(fields: [order_id], references: [id])
  payer_id          String
  payer             User          @relation(fields: [payer_id], references: [id])
  amount            Decimal       @db.Decimal(10, 2)
  payment_method    PaymentMethod
  status            PaymentStatus @default(UNPAID)
  payment_proof_url String?
  transaction_ref   String?       // Mã giao dịch từ MoMo/ZaloPay/QR
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
}

model Conversation {
  id         String        @id @default(cuid())
  user1_id   String
  user1      User          @relation("User1", fields: [user1_id], references: [id])
  user2_id   String
  user2      User          @relation("User2", fields: [user2_id], references: [id])
  messages   ChatMessage[]
  created_at DateTime      @default(now())
}

model ChatMessage {
  id              String       @id @default(cuid())
  conversation_id String
  conversation    Conversation @relation(fields: [conversation_id], references: [id])
  sender_id       String
  sender          User         @relation(fields: [sender_id], references: [id])
  message_content String       @db.Text
  created_at      DateTime     @default(now())
}

model Review {
  id          String   @id @default(cuid())
  order_id    String
  order       Order    @relation(fields: [order_id], references: [id])
  reviewer_id String
  user        User     @relation(fields: [reviewer_id], references: [id])
  rating      Int      @default(5)
  comment     String?  @db.Text
  created_at  DateTime @default(now())
}

model Attachment {
  id          String     @id @default(cuid())
  url         String
  file_type   String
  target_id   String
  target_type TargetType
  created_at  DateTime   @default(now())

  @@index([target_id, target_type])
}

// --- THÊM BẢNG LƯU MÃ OTP (VERIFICATION) ---
model Verification {
  id         String            @id @default(cuid())
  code       String
  type       AccountIdentifier @default(EMAIL)
  userId     String
  expires_at DateTime
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}